#!/bin/bash

# declare all allowed directories
declare -a directories=( 'app/code' 'app/etc' 'app/locale' 'app/design' js lib media skin shell var)

echo "# Modman file generated by 'generate-modman' (https://github.com/mhauri/generate-modman)" > modman

function handle_app_code() {
    # link only directories
    find app/code -type d -mindepth 3 -maxdepth 3 -path "*app/code/local/*" -o -path "*app/code/community/*"
}

function handle_app_etc() {
    # link all files
    find app/etc -type f ! -iname ".*"
}

function handle_app_locale() {
    find app/locale -type f ! -iname ".*"
}

function handle_app_design() {
    # link all directories who aren't default
    find app/design -type d -mindepth 2 -maxdepth 2 \( ! -path "*frontend/rwd*" ! -path "*frontend/default*" ! -path "*frontend/base*" ! -path "*adminhtml/default*" ! -path "*install/default*" \)
    # link files in default directories
    find app/design -type f ! -iname ".*" \( -path  "*frontend/rwd*" -o -path "*frontend/default*" -o -path "*frontend/base*" -o -path "*adminhtml/default*" -o -path "*install/default*" \)
}

function handle_js() {
    find js -type f -mindepth 1 ! -iname ".*"
}

function handle_lib() {
    find lib -type f -mindepth 1 ! -iname ".*"
}

function handle_media() {
    find media -type f -mindepth 1 ! -iname ".*"
}

function handle_skin() {
    # link all directories who aren't default
    find skin -type d -mindepth 2 -maxdepth 2 \( ! -path "*frontend/rwd*" ! -path "*frontend/default*" ! -path "*frontend/base*" ! -path "*adminhtml/default*" ! -path "*adminhtml/base*" ! -path "*install/default*" \)
    # link files in default directories
    find skin -type f ! -iname ".*" \( -path  "*frontend/rwd*" -o -path "*frontend/default*" -o -path "*frontend/base*" -o -path "*adminhtml/default*" -o -path "*adminhtml/base*" -o -path "*install/default*" \)
}

function handle_shell() {
    find shell -type f -mindepth 1 ! -iname ".*"
}

function handle_var() {
    find var -type d -mindepth 1 -maxdepth 1
}

# call all handlers
for dir in "${directories[@]}"; do
  if [ -d "$dir" ]; then
    echo "# ${dir}" >> modman
    handle_${dir//\//_} | awk '{ print $0 "            " $0 }' >> modman
  fi
done
